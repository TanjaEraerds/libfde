pipeline { 
    agent any 
    stages {
        stage('show config') { 
            steps { 
                sh 'env'
            }
        }
        stage('Build') { 
            steps {
                script {
                    def fc = ['ifort', 'gfortran']
                    for (int i = 0; i < fc.size(); ++i) {
                        sh "make clean built FC=${fc[i]} CFG=release -j4"
                    }
                }
            }
        }
        stage('Testing') {
            steps { 
                dir('test') {
                    sh 'rm -rf exe'
                    script {
                        def fc   = ['ifort', 'gfortran']
                        def test = []
                        final foundFiles = findFiles(glob: 'test_*.f90')
                        foundFiles.each {
                            println it
                        }

                        //// consider all files "test_*.f90" as test
                        //new File('.').eachFile {
                        //    f = it.getName()
                        //    if (f.startsWith('test_') && f.endsWith('.f90')) {
                        //        test << f.substring( 0, f.length()-4 )
                        //    }
                        //}
                        for (int i = 0; i < fc.size(); ++i) {
                            for (int j = 0; j < test.size(); ++j) {
                                sh "make clean test_${test[j]} FC=${fc[i]} CFG=release"
                                sh "`make -s eval,OUT_DIR FC=${fc[i]} CFG=release`/test_${test[j]}"
                            }
                        }
                    }
                }
            }
        }
    }
}

